# 智元日志-2025.10  

## 上半月小结

* **工作任务** ：  
  * 上半月主要的工作任务为调通BMS板子和墨水屏板子之间的UART数据通信和墨水屏数据显示问题

* **工作难点** ：  
  * 硬件电路框架、软件代码框架不熟悉  
  * 开发板资源有限，难以串口调试，只能用keil的debug追踪调试

* **问题缺陷** ：  
  * 裸机开发操作经验不足  
  * 开发调试工具使用经验不足  
  * 调试bug方法方案不成熟  

* **调试过程** ：
  * *开发需求* ：墨水屏板子按照既定轮询策略，周期性地向BMS板子发送查询信息指令，BMS板子通过uart串口反馈电池信息给墨水屏板子，并将信息显示到墨水屏上。
    接手项目时，BMS板子为外包给其他厂家制作，其硬件软件都无法修改，只能修改墨水屏板子的程序，已有轮询发送查询信息的逻辑，需修改墨水屏板子接收信息部分和处理的部分，墨水屏板子暂时接收不到数据。
    能收到数据后，发现墨水屏buffer中为接收满了才调用接收完成回调函数，后修改为DMA接收+UART空闲中断中接收数据并调用接受完成回调函数处理所接收的数据  
  * *问题解耦*：在keil中debug发现，墨水屏接收数据的buffer中一直没有预期接收到的数据。修改数据链路连接，用墨水屏tx连接BMS的rx，电脑接收BMS的tx，发现上位机sscom中能收到预期从BMS获取的数据信息，因此推断，墨水屏按预期发送了查询信息，BMS也按预期发送了相应数据，但墨水屏没接收到。再修改数据链路连接，电脑串口tx连接墨水屏rx，发送响应电池信息，墨水屏上按预期显示电压电流等信息，因此推断，是墨水屏的rx或者BMS板子的tx硬件电路连接方面出现了问题。

* **数据链路** ：  
    - 外设产生UART空闲中断接收事件，在中断使能`USART_IRQHandler()`中开启了`UART_IT_IDLE`并使能了USART2中断，当事件发生时，NVIC触发了`USART_IRQHandler()`,调用空闲回调中断处理`HAL_UARTEx_RxEventCallback()`，UART空闲中断处理`HAL_UARTEx_RxEventCallback()`，再调用`bms_uart.c`中空闲中断回调函数`BmsUart_ldleCallback()`调用接收函数，`handle_rx_complete()`接收完成之后，再调用回调函数`uart_rx_callback()`，回调函数再调用寄存器读写响应函数`handle_register_response()`，该响应函数调用数据更新回调函数`BmsProtocol_RegisterDataCallback()`，再调用数据解析函数`bms_data_update_callback()`，完成对底层变量数据的更新。

* **感想领悟** ：  
  * 遇到问题学会解耦，设计不同的方案去逐步验证，找到问题所在；
  * 学习利用工具并善于利用工具，软件方面STM32Cube系列，硬件方面示波器、万用表、逻辑分析仪等；

## 10.22

> 今天一整天都在东莞工厂中，学习工厂的生产相关，今日任务顺延到明天；

* 计划安排 ：
  * 跟踪调试机器；
  * STM32CubeMX配置相关技能；
  * 使用逻辑分析仪读取BMS板和墨水屏；
  * 调查锋哥安排的问题：搞清楚哪里有问题，有什么问题，需要怎么测试，怎么排查，现象是什么，测查文档需要着重哪些点；

* 工作内容 ：
  * 驻厂协助
  * STM32CubeMX精进
  * 锋哥安排的任务分析，知道要做什么，要怎么做

## 10.23  
* 工作内容：
   - 完成锋哥安排的任务：X2电源运控板PMU模块MCU无法用STLINK连接，STM32Cubeprogrammer无法连接板子，无法正常烧录程序；从ioc配置文件上看，该debug口可以配置为debug模式，也可以配置成GPIOout模式，在串口上通过相应指令，配置io模式，再将PMU的SWD口外接高电平或低电平，再通过串口终端读取GPIO口 PA13是否为对应的电平值，并以此判断此GPIO是否工作正常；
   - 可以发现SWD口(即PA13)无法从外部拉为低电平，故判断该引脚有问题，无法检测外部电平信号；
   - 后续完成对应检测报告，并发给运控版对应负责人；

## 10.24  
- 计划安排 ：
  - 学习使用逻辑分析仪读取BMS板和墨水屏通信数据；
  - 视频学习STM32CubeMX配置相关技能；
  - 视频学习强化学习；
  - 阅读代码：DCU中debug部分；
